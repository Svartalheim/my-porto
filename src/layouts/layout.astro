---
import { ClientRouter } from 'astro:transitions';
import BottomBar from '../components/BottomBar.astro';
import Footer from '../layouts/Footer.astro';
import '../styles/global.css';

export interface Props {
  name?: string;
  title?: string;
}
const { name, title } = Astro.props as Props;
---

<html lang='en'>
  <head>
    <ClientRouter fallback={'none'} transition:animate={'none'} />

    <meta charset='utf-8' />
    <link rel='icon' type='image/svg+xml' href='/favicon.svg' />
    <meta name='viewport' content='width=device-width' />
    <meta name='generator' content={Astro.generator} />
    <title>{title ? title : name ? `${name} | Astro` : 'Astro'}</title>

    <link rel='preconnect' href='https://fonts.googleapis.com' />
    <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin />

    <!-- <script is:inline>
      if ('startViewTransition' in document) {
        document.__nativeStartViewTransition__ =
          document.startViewTransition.bind(document);
        document.startViewTransition = (cb) => {
          let resolveFinished;
          const finished = new Promise((res) => (resolveFinished = res));
          const ready = Promise.resolve();
          let updateCallbackDone = Promise.resolve();
          try {
            const r = cb?.();
            if (r && typeof r.then === 'function') updateCallbackDone = r;
          } catch (_) {}
          Promise.resolve(updateCallbackDone).then(() => resolveFinished());
          return { finished, ready, updateCallbackDone, skipTransition() {} };
        };
      }
    </script> -->

    <style is:global>
      html {
        overflow-x: hidden;
      }

      .page-container {
        position: relative;
        width: 100%;
        min-height: 100vh;
      }

      #page {
        --blur-p: 0;
        --blr-m: var(--grid-margin);
        --blr-s-min: 0.032;
        --blr-s-max: 0.0474;
        --blr-s: var(--blr-s-min);
        position: relative;
        z-index: 1;
        will-change: transform;
        transform-origin: var(--origin-x, 50%) var(--origin-y, 50%);
        transition-duration: var(--MENU_DURATION, 0.2s);
        transition-property: transform, opacity;
        transition-timing-function: linear;
      }

      @media (max-width: 743px) {
        #page {
          --blr-m: 10px;
        }
      }
      @media (max-width: 1200px) {
        #page {
          --blr-s: 0.037;
        }
      }
      @media (max-width: 900px) {
        #page {
          --blr-s: 0.0594;
        }
      }
      @media (max-width: 600px) {
        #page {
          --blr-s: var(--blr-s-max);
        }
      }

      #page .page-content {
        will-change: transform;
        transform-origin: var(--origin-x, 50%) var(--origin-y, 50%);
        transition-duration: var(--MENU_DURATION, 0.2s);
        transition-property: transform, opacity;
        transition-timing-function: linear;
      }

      /* ====== Manual transition (no Astro VT) ====== */

      /* Ghost (old page snapshot) is appended directly to <body> */

      #ghost-layer {
        z-index: 20;
      }

      .ghost-page {
        position: fixed;
        overflow: clip;
        pointer-events: none;
        will-change: transform, opacity;
        z-index: 20; /* above #page (z-1), below persistent chrome if needed */
        background: var(--background);
      }

      /* OLD page (ghost) leave — your slide-out-down equivalent */
      .ghost-leave {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
      .ghost-leave-active {
        transition:
          transform var(--transition-duration, 400ms)
            var(--transition-timing, cubic-bezier(0.4, 0, 0.2, 1)),
          opacity var(--transition-duration, 400ms) linear;
        transform: translate(--origin-x, --origin-y) rotate(1deg) scale(0.95);
        opacity: 0.3;
      }

      /* NEW page enter — your slide-in-bottom */
      .page-enter {
        transform: translateY(75%);
        opacity: 1;
      }
      .page-enter-active {
        transition: transform var(--transition-duration, 400ms)
          var(--transition-timing, cubic-bezier(0.4, 0, 0.2, 1));
        transform: translateY(0%);
      }

      @media (prefers-reduced-motion: reduce) {
        .ghost-leave,
        .page-enter {
          transform: none !important;
          opacity: 1 !important;
        }
        .ghost-leave-active,
        .page-enter-active {
          transition: none !important;
        }
      }

      /* Keep element-level niceties */
      .page-content * {
        transition-property: transform, opacity, scale;
        transition-timing-function: var(--transition-timing);
      }

      #page[data-blurred='true'] .page-content {
        transform: scale(calc(1 - (var(--blr-s) * var(--blur-p))));
        /* opacity: calc(1 - 0.2333 * var(--blur-p)); */
      }
      #page [data-blur-mask] > div {
        position: sticky;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
      }

      #page[data-blurred='true']::after {
        content: '';
        position: absolute;
        left: 0;
        /* right: 0; */
        height: 20vh;
        overflow: hidden;
        background-color: red; /* match #page bg */
        pointer-events: none; /* don't block clicks */
        bottom: -10vh;
      }

      #page [data-blur-mask] > div > div:first-child:before {
        left: 0;
        transform-origin: left;
      }
      #page [data-blur-mask] > div > div:first-child:after {
        right: 0;
        transform-origin: right;
      }
      #page [data-blur-mask] > div > div:after,
      #page [data-blur-mask] > div > div:before {
        content: '';
        position: absolute;
        background-color: #000;
        will-change: transform;
      }
      #page [data-blur-mask] > div > div:first-child:after,
      #page [data-blur-mask] > div > div:first-child:before {
        width: var(--blr-m);
        height: 100%;
        top: 0;
        transform: scaleX(var(--blur-p));
      }
      #page [data-blur-mask] > div > div:nth-child(2):before {
        top: 0;
        transform-origin: top;
      }

      /* #page [data-blur-mask]>div>div:nth-child(2):after, */
      #page [data-blur-mask] > div > div:nth-child(2):before {
        width: 100%;
        height: var(--blr-m);
        left: 0;
        transform: scaleY(var(--blur-p));
      }

      #page [data-blur-mask] > div > div:nth-child(3):before {
        left: var(--blr-m);
        border-top-left-radius: 20px;
        transform-origin: 0% 0%;
        transform: translate(
            calc((var(--blur-p) - 1) * var(--blr-m)),
            calc((var(--blur-p) - 1) * var(--blr-m))
          )
          scale(var(--blur-p));
      }

      #page [data-blur-mask] > div > div:nth-child(3):after {
        right: var(--blr-m);
        border-top-right-radius: 20px;
        transform-origin: 100% 0%;
        transform: translate(
            calc(-1 * (var(--blur-p) - 1) * var(--blr-m)),
            calc((var(--blur-p) - 1) * var(--blr-m))
          )
          scale(var(--blur-p));
      }

      #page [data-blur-mask] > div > div:nth-child(3):after,
      #page [data-blur-mask] > div > div:nth-child(3):before {
        top: var(--blr-m);
        width: var(--page-border-radius);
        height: calc(2 * var(--page-border-radius));
        box-shadow: 0 calc(-1 * var(--page-border-radius)) 0 0 #000;
        background-color: rgba(0, 0, 0, 0);
      }
    </style>
  </head>

  <body class=''>
    <!-- Persistent chrome -->
    <BottomBar transition:persist transition:animate='none' />
    <div
      id='ghost-layer'
      transition:persist
      style='position:fixed; inset:0; pointer-events:none; '
    >
    </div>
    <div
      data-slug={name}
      class='page-container bg-background relative h-full max-w-[var(--100vw)]'
      id='page'
      transition:name='ssss'
    >
      <div class='page-content'>
        <slot />
        <Footer />
      </div>

      <div
        data-blur-mask
        inert
        aria-hidden='true'
        class='absolute w-full h-full top-0 left-0 pointer-events-none'
      >
        <div>
          <div id='#overlay-left-right'></div>
          <div id='#overlay-top'></div>
          <div id='#overlay-corner'></div>
        </div>
        <span></span>
      </div>
    </div>

    <!-- Manual transition controller (GSAP-powered) -->
    <script>
      import { gsap } from 'gsap';

      const DURATION = 5,
        EASE = 'power2.out';
      const prefersReduced = matchMedia(
        '(prefers-reduced-motion: reduce)'
      ).matches;
      const ghostLayer = document.getElementById('ghost-layer');

      function stageOldPageLeave(pageEl) {
        if (!pageEl || !ghostLayer) return;
        const rect = pageEl.getBoundingClientRect();
        const ghost = pageEl.cloneNode(true);

        ghost.classList.add('ghost-page');
        Object.assign(ghost.style, {
          position: 'fixed',
          top: rect.top + 'px',
          left: rect.left + 'px',
          width: rect.width + 'px',
          height: rect.height + 'px',
          transform: 'none',
          opacity: '1',
          pointerEvents: 'none',
        });

        // clear previous ghosts
        ghostLayer.querySelectorAll('.ghost-page').forEach((el) => {
          gsap.killTweensOf(el);
          el.remove();
        });
        ghostLayer.appendChild(ghost);

        if (prefersReduced) return;

        requestAnimationFrame(() => {
          gsap.to(ghost, {
            duration: DURATION,
            ease: EASE,
            yPercent: 10,
            xPercent: 1,
            rotate: 1,
            scale: 0.95,
            autoAlpha: 0,
            onComplete: () => ghost.remove(),
          });
        });
      }

      function animateNewPageEnter() {
        if (prefersReduced) return;
        const page = document.getElementById('page');
        if (!page) return;
        gsap.killTweensOf(page);
        gsap.fromTo(
          page,
          { yPercent: 75 },
          {
            yPercent: 0,
            duration: DURATION,
            ease: EASE,
            clearProps: 'transform',
          }
        );
      }

      // Hook the Astro lifecycle
      document.addEventListener('astro:before-preparation', () => {
        const current = document.getElementById('page');
        stageOldPageLeave(current);
      });

      document.addEventListener('astro:after-swap', () => {
        animateNewPageEnter();
      });
    </script>
  </body>
</html>

<script>
  import Lenis from 'lenis';
  (function () {
    if (!(window as any).__lenis)
      (window as any).__lenis = new Lenis({ autoRaf: true });
    const lenis = (window as any).__lenis;

    document.addEventListener('astro:before-preparation', () => {
      if (lenis && typeof lenis.stop === 'function') lenis.stop();
    });
    document.addEventListener('astro:after-swap', () => {
      if (lenis && typeof lenis.start === 'function') lenis.start();
    });
  })();
</script>

<script>
  /* @ts-nocheck */
  function getPageEl() {
    return document.getElementById('page');
  }
  const EDGE_PAD_PCT = 4;
  const lerp = (a, b, t) => a + (b - a) * t;
  const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
  function computeOriginFromViewport(edgePadPct = EDGE_PAD_PCT) {
    const page = getPageEl();
    if (!page) return;
    const rect = page.getBoundingClientRect();
    const pageTopAbs = rect.top + window.scrollY;
    const pageHeight = Math.max(page.scrollHeight, page.clientHeight);
    const viewportH = window.innerHeight;
    const scrollable = Math.max(pageHeight - viewportH, 0);
    const scrollInPage = Math.min(
      scrollable,
      Math.max(0, window.scrollY - pageTopAbs)
    );
    const p = scrollable > 0 ? scrollInPage / scrollable : 0.5;
    const yPct = lerp(edgePadPct, 100 - edgePadPct, p);
    page.style.setProperty('--origin-x', '50%');
    page.style.setProperty('--origin-y', `${yPct}%`);
  }

  function setOriginFromEvent(e) {
    const page = getPageEl();
    if (!page || !e) return;
    const rect = page.getBoundingClientRect();
    const xWithin = e.clientX - rect.left;
    const yWithin = e.clientY - rect.top;
    const xPct = (xWithin / rect.width) * 100;
    const h = Math.max(page.scrollHeight, page.clientHeight);
    const yPct =
      ((yWithin + window.scrollY - (rect.top + window.scrollY)) / h) * 100;
    page.style.setProperty(
      '--origin-x',
      `${Math.min(100, Math.max(0, xPct))}%`
    );
    page.style.setProperty(
      '--origin-y',
      `${Math.min(100, Math.max(0, yPct))}%`
    );
  }

  window['__setScaleOrigin'] = function (xPct, yPct) {
    const page = getPageEl();
    if (!page) return;
    if (typeof xPct === 'number')
      page.style.setProperty(
        '--origin-x',
        `${Math.min(100, Math.max(0, xPct))}%`
      );
    if (typeof yPct === 'number')
      page.style.setProperty(
        '--origin-y',
        `${Math.min(100, Math.max(0, yPct))}%`
      );
  };

  let rafId = null;
  function scheduleCompute() {
    if (rafId !== null) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(() => {
      computeOriginFromViewport();
      rafId = null;
    });
  }
  window.addEventListener('scroll', scheduleCompute, { passive: true });
  window.addEventListener('resize', scheduleCompute, { passive: true });
  window.addEventListener('orientationchange', scheduleCompute, {
    passive: true,
  });

  document.addEventListener(
    'click',
    (e) => {
      const t = e.target;
      if (
        t instanceof Element &&
        t.closest('[data-origin-anchor],[data-expand],[data-open]')
      ) {
        setOriginFromEvent(e);
      }
    },
    { capture: true }
  );

  function initOrigin() {
    computeOriginFromViewport();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initOrigin);
  } else {
    initOrigin();
  }
  document.addEventListener('astro:after-swap', initOrigin);
</script>
